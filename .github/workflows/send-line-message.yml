name: LINE Water Check Notification

on:
  schedule:
    - cron: '15 9 * * *'  # JST 9:00
  workflow_dispatch:

jobs:
  notify-if-no-water:
    runs-on: ubuntu-latest
    steps:
      - name: Check Firestore and notify LINE
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_GROUP_ID: ${{ secrets.LINE_GROUP_ID }}
        run: |
          echo "Checking Firestore record for today..."

          TODAY=$(date -u +"%Y-%m-%d" -d "+9 hours")

          HEADER='{
            "alg": "RS256",
            "typ": "JWT"
          }'

          NOW=$(date +%s)
          EXP=$(($NOW + 3600))

          CLAIM='{
            "iss": "'"$FIREBASE_CLIENT_EMAIL"'",
            "sub": "'"$FIREBASE_CLIENT_EMAIL"'",
            "aud": "https://oauth2.googleapis.com/token",
            "iat": '"$NOW"',
            "exp": '"$EXP"',
            "scope": "https://www.googleapis.com/auth/datastore"
          }'

          b64enc() { openssl base64 -e -A | tr '+/' '-_' | tr -d '='; }

          JWT_HEADER=$(echo -n "$HEADER" | b64enc)
          JWT_CLAIM=$(echo -n "$CLAIM" | b64enc)
          JWT_UNSIGNED="$JWT_HEADER.$JWT_CLAIM"

          echo "$FIREBASE_PRIVATE_KEY" > private_key.pem

          JWT_SIGNATURE=$(echo -n "$JWT_UNSIGNED" | openssl dgst -sha256 -sign private_key.pem | b64enc)
          JWT="$JWT_UNSIGNED.$JWT_SIGNATURE"

          ACCESS_TOKEN=$(curl -s -X POST https://oauth2.googleapis.com/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=$JWT" \
            | jq -r '.access_token')

          FIRESTORE_URL="https://firestore.googleapis.com/v1/projects/$FIREBASE_PROJECT_ID/databases/(default)/documents/water-records/$TODAY"

          echo "Checking document: $FIRESTORE_URL"
          RESPONSE=$(curl -s -X GET "$FIRESTORE_URL" \
            -H "Authorization: Bearer $ACCESS_TOKEN")

          echo "$RESPONSE" | jq .

          if echo "$RESPONSE" | grep -q '"time1"'; then
            echo "‚úÖ Watering record exists ‚Äî no need to notify."
          else
            echo "‚ùå No watering record found ‚Äî sending LINE notification..."
            curl -X POST https://api.line.me/v2/bot/message/push \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $LINE_CHANNEL_ACCESS_TOKEN" \
              -d '{
                    "to": "'"$LINE_GROUP_ID"'",
                    "messages":[
                      {
                        "type":"text",
                        "text":"üå± Êú¨Êó•„Åæ„Å†Ê∞¥„ÇÑ„ÇäË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„ÇìÔºÅÁ¢∫Ë™ç„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ"
                      }
                    ]
                  }'
          fi
