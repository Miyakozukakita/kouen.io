name: LINE Water Check Notification

on:
  schedule:
    - cron: '0 0 * * *'  # JST 9:00
  workflow_dispatch:

jobs:
  notify-if-no-water:
    runs-on: ubuntu-latest
    steps:
      - name: Check Firestore and notify LINE
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_GROUP_ID: ${{ secrets.LINE_GROUP_ID }}
        run: |
          echo "â–¶ é–‹å§‹ï¼šFirestore ã‹ã‚‰æ°´ã‚„ã‚Šè¨˜éŒ²ã‚’ç¢ºèª"

          TODAY=$(date -u +"%Y-%m-%d" -d "+9 hours")
          echo "ğŸ“… ä»Šæ—¥ã®æ—¥ä»˜ï¼ˆJSTï¼‰: $TODAY"

          HEADER='{
            "alg": "RS256",
            "typ": "JWT"
          }'

          NOW=$(date +%s)
          EXP=$(($NOW + 3600))

          CLAIM='{
            "iss": "'"$FIREBASE_CLIENT_EMAIL"'",
            "sub": "'"$FIREBASE_CLIENT_EMAIL"'",
            "aud": "https://firestore.googleapis.com/",
            "iat": '"$NOW"',
            "exp": '"$EXP"',
            "scope": "https://www.googleapis.com/auth/datastore"
          }'

          b64enc() { openssl base64 -e -A | tr '+/' '-_' | tr -d '='; }

          JWT_HEADER=$(echo -n "$HEADER" | b64enc)
          JWT_CLAIM=$(echo -n "$CLAIM" | b64enc)
          JWT_UNSIGNED="$JWT_HEADER.$JWT_CLAIM"

          echo "$FIREBASE_PRIVATE_KEY" > private_key.pem
          JWT_SIGNATURE=$(echo -n "$JWT_UNSIGNED" | openssl dgst -sha256 -sign private_key.pem | b64enc)
          JWT="$JWT_UNSIGNED.$JWT_SIGNATURE"

          echo "ğŸ”‘ JWT ä½œæˆå®Œäº†"

          ACCESS_TOKEN=$(curl -s -X POST https://oauth2.googleapis.com/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=$JWT" \
            | jq -r '.access_token')

          echo "ğŸ”“ ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æ¸ˆã¿"

          FIRESTORE_URL="https://firestore.googleapis.com/v1/projects/$FIREBASE_PROJECT_ID/databases/(default)/documents/water-records/$TODAY"
          echo "ğŸ“¡ Firestore ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—: $FIRESTORE_URL"

          RESPONSE=$(curl -s -X GET "$FIRESTORE_URL" \
            -H "Authorization: Bearer $ACCESS_TOKEN")

          echo "ğŸ§¾ Firestore ãƒ¬ã‚¹ãƒãƒ³ã‚¹:"
          echo "$RESPONSE" | jq .

          HAS_TIME1=$(echo "$RESPONSE" | jq -r '.fields.time1.stringValue // empty')

          if [ -n "$HAS_TIME1" ]; then
            echo "âœ… æ°´ã‚„ã‚Šæ¸ˆã¿è¨˜éŒ²ã‚’ç¢ºèªï¼ˆtime1: $HAS_TIME1ï¼‰"
          else
            echo "âŒ time1 ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼LINEã¸é€šçŸ¥ã—ã¾ã™ã€‚"
          fi

          echo "âœ… å‡¦ç†å®Œäº†"
